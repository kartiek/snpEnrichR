---
title: "Basic usage of snpEnrichR package"
author:
- name: Kari Nousiainen
  affiliation: 
  - Aalto Univerisity School of Science
  email: Kari.Nousiainen@Aalto.FI
- name: Kartiek Kanduri
  affiliation: 
    - Aalto Univerisity School of Science
    - University of Turku
  email: Kartiek.Kanduri@Aalto.FI 
date: "`r Sys.Date()`"
package: snpEnrichR
output:   BiocStyle::html_document
vignette: > 
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!--
%% \VignetteEngine{knitr::knitr}
-->

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```


# Abstract

snpEnrichR implements methods to analyze enrichment of SNPs in genomic regions.

# Supported functionalities
* Download SNPs from EBI's GWAS
* Decorrelate  SNP sets
* Query randomized SNP sets matching the SNP set from snpSNAP
* Find SNPs correlated to input SNPs within a given distance
* Perform enrichment analysis, including overlap computation, empirical statistical hypothesis testing with Benjamini-Hochberg multiple hypothesis correction 

# Citation 

The citation instructions come here when published.

# Introduction

snpEnrichR is a tool for estimating Enrichment of association between (trait specific) SNPs and genomic regions by performing an empirical statististical test. In order to estimate a null distribution for a statistical hypothesis test the set of genomic regions is considered as the reference set, and the set of trait specific SNPs is randomized multiple times such that the major characteristics of SNPs are conserved. As SNPs occur in linkage disequilibrium (LD) and genotyping methods used in GWAS studies have limited resolution, the link between SNPs and genomic regions may be indirect; observed through other SNPs in the LD. snpEnrichR supports possibility to expand  the set of SNPs with their LD buddies.

# `getSNPs`: Download trait specific SNPs from NHGRI-EBI GWAS Catalog 
snpEnrichR provides `getSNPs` for NHGRI-EBI GWAS Catalog query.
```R
# query term
qt <- 'psoriasis'
GWAS_SNPS <- getSNPs(qt)
str(GWAS_SNPS,vec.len=1,nchar.max=134)
```

```R
'data.frame':	422 obs. of  34 variables:
 $ DATE ADDED TO CATALOG     : chr  "2016-10-14" ...
 $ PUBMEDID                  : chr  "26626624" ...
 $ FIRST AUTHOR              : chr  "Stuart PE" ...
 $ DATE                      : chr  "2015-11-28" ...
 $ JOURNAL                   : chr  "Am J Hum Genet" ...
 $ LINK                      : chr  "www.ncbi.nlm.nih.gov/pubmed/26626624" ...
 $ STUDY                     : chr  "Genome-wide Association Analysis of Psoriatic Arthritis and Cutaneous Psoriasis Reveals Differences in Their Genetic Architecture." ...
 $ DISEASE/TRAIT             : chr  "Cutaneous psoriasis" ...
 $ INITIAL SAMPLE SIZE       : chr  "1,363 European ancestry cases, 4,934 European ancestry controls" ...
 $ REPLICATION SAMPLE SIZE   : chr  "up to 2,969 European ancestry cases, up to European ancestry 14,384 controls" ...
 $ REGION                    : chr  "10q21.2" ...
 $ CHR_ID                    : chr  "10" ...
 $ CHR_POS                   : chr  "62778519" ...
 $ REPORTED GENE(S)          : chr  "ADO" ...
 $ MAPPED_GENE               : chr  "ALDH7A1P4 - ADO" ...
 $ UPSTREAM_GENE_ID          : chr  "544" ...
 $ DOWNSTREAM_GENE_ID        : chr  "84890" ...
 $ SNP_GENE_IDS              : chr  "" ...
 $ UPSTREAM_GENE_DISTANCE    : chr  "37125" ...
 $ DOWNSTREAM_GENE_DISTANCE  : chr  "26237" ...
 $ STRONGEST SNP-RISK ALLELE : chr  "rs7922314-C" ...
 $ SNPS                      : chr  "rs7922314" ...
 $ MERGED                    : chr  "0" ...
 $ SNP_ID_CURRENT            : chr  "7922314" ...
 $ CONTEXT                   : chr  "intergenic_variant" ...
 $ INTERGENIC                : chr  "1" ...
 $ RISK ALLELE FREQUENCY     : chr  "0.9206" ...
 $ P-VALUE                   : chr  "2E-6" ...
 $ PVALUE_MLOG               : chr  "5.698970004336019" ...
 $ P-VALUE (TEXT)            : chr  "" ...
 $ OR or BETA                : chr  "1.33" ...
 $ 95% CI (TEXT)             : chr  "NR" ...
 $ PLATFORM [SNPS PASSING QC]: chr  "Illumina [11532644] (imputed)" ...
 $ CNV                       : chr  "N" ...
```
The data frame contains all SNPs available. Hence, it should be parsed to match required criteria e.g. disease/trait, population, p-value etc. For example, considering all SNPs where Disease/treat is "Psoriasis" related to studies where cases and control are from European populations and keeping duplicate SNPs in the list would produce the following table.

```R
'data.frame':	46 obs. of  7 variables:
 $ chr          : chr  "13" "20" "6" "6" ...
 $ start        : chr  "39776775" "49905793" "31306778" "31464003" ...
 $ end          : chr  "39776775" "49905793" "31306778" "31464003" ...
 $ strand       : chr  "*" "*" "*" "*" ...
 $ DISEASE/TRAIT: chr  "Psoriasis" "Psoriasis" "Psoriasis" "Psoriasis" ...
 $ P-VALUE      : chr  "2E-6" "1E-8" "2E-39" "2E-26" ...
 $ SNPS         : chr  "rs7993214" "rs495337" "rs10484554" "rs2395029" 
```

The downloaded data is mapped to genome assembly GRCh38 whereas the following steps require mapping to hg19. Hence, liftover is needed. We use a reference SNP database that consists of 1000G SNPs which are tranformed to plink format using chromosomal positions as identifiers.  

```R
require(rtracklayer)
ch = import.chain('data/hg38ToHg19.over.chain')
# HLA regions to be filtered out
HLA <- GRanges( Rle("6",1),IRanges(25000000,35000000))
snpObjects <- sort(unique(makeGRangesFromDataFrame(snpTable, 
seqnames.field="chr",keep.extra.columns=TRUE)))
seqlevelsStyle(snpObjects) <- "UCSC"
snpObjectsLiftedOver<-unlist(liftOver(snpObjects, ch))
if (any(countOverlaps(snpObjectsLiftedOver, HLA)<1L))
snpObjectsLiftedOver <- snpObjectsLiftedOver[countOverlaps(snpObjectsLiftedOver, HLA)<1L,]
snpsNewCoords<-data.frame(snpObjectsLiftedOver)
snpList <- apply(snpsNewCoords[,1:2],1,function(x) gsub("chr","",paste(trimws(x),collapse =":"))) 
```

# `clumpSNPs`: Decorrelate  SNP sets 
SNPs must be decorrelated as correlated SNPs cause biases when drawing random SNP sets.
```R
snpList <-clumpSNPs('../Data/ThousandGenomes/1kp3_snpSNAP',
                    snpList,
                    '../Data/non_clumped_snp',
                    0.8,
                    1000)
```

# `submitSNPsnap`: Query randomized SNP sets matching the SNP set from snpSNAP
```R
snpSNAPUrl = submitSNPsnap(snpList,
                          distance_type ="kb",
                          distance=1000,
                          clump_r2="0.8",
                          clump_kb="1000",
                          max_ld_buddy_count_deviation=20,
                          ld_buddy_cutoff = "0.8",
                          N_sample_sets=1000,
                          email_address = "kari.nousiainen@aalto.fi",job_name=trait)
```

# `findProxies`: Find LD buddies for SNPs

# `analyzeEnrichment`: Perform the actual analysis


Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
